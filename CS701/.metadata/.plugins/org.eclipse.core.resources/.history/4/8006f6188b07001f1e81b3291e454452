#include <stdio.h>
#include "system.h"
#include "altera_avalon_pio_regs.h"
#include <stdint.h>


int key;

void key_isr() {
	key = IORD_ALTERA_AVALON_PIO_EDGE_CAP(KEY_BASE);
	IOWR_ALTERA_AVALON_PIO_EDGE_CAP(KEY_BASE, 0x7);
}

int main() {
	int edge, edge1, edge2, toggle1 = 0, toggle2 = 0, state = 0;

	IOWR_ALTERA_AVALON_PIO_EDGE_CAP(KEY_BASE, 0x7);
	IOWR_ALTERA_AVALON_PIO_IRQ_MASK(KEY_BASE, 0x7);
	alt_irq_register(KEY_BASE, 0, key_isr);

	while (1) {
		printf("State num %d\n", state);
		if ((key == 0x1)) {
			printf("Stupid\n");
			if (state > 4) {
				state = 4;
			} else {
				state = 9;
			}
		} else if ((key == 0x2)) {
			printf("Stupid\n");
			IOWR_ALTERA_AVALON_PIO_DATA(ADDR_BASE, 0x01);
			toggle2 = !toggle2;
			if (toggle2 == 1) {
				IOWR_ALTERA_AVALON_PIO_DATA(SEND_BASE, 0xb1000000);
			} else {
				IOWR_ALTERA_AVALON_PIO_DATA(SEND_BASE, 0xb1020000);
			}
		} else if ((key == 0x4)) {
			IOWR_ALTERA_AVALON_PIO_DATA(ADDR_BASE,0x01);
			toggle1 = !toggle1;
			if (toggle1 == 1) {
				IOWR_ALTERA_AVALON_PIO_DATA(SEND_BASE, 0xb1010000);
			} else {
				IOWR_ALTERA_AVALON_PIO_DATA(SEND_BASE, 0xb1030000);
			}
		} else {
			switch (state) {
			case 9:
				IOWR_ALTERA_AVALON_PIO_DATA(ADDR_BASE, 0x01);
				IOWR_ALTERA_AVALON_PIO_DATA(SEND_BASE, 0xb1020000);
				state = 8;
				break;
			case 8:
				IOWR_ALTERA_AVALON_PIO_DATA(ADDR_BASE, 0x01);
				IOWR_ALTERA_AVALON_PIO_DATA(SEND_BASE, 0xb1030000);
				state = 7;
				break;
			case 7:
				IOWR_ALTERA_AVALON_PIO_DATA(ADDR_BASE, 0x00);
				IOWR_ALTERA_AVALON_PIO_DATA(SEND_BASE, 0xa0320000);
				state = 6;
				break;
			case 6:
				IOWR_ALTERA_AVALON_PIO_DATA(ADDR_BASE, 0x00);
				IOWR_ALTERA_AVALON_PIO_DATA(SEND_BASE, 0xa0330000);
				state = 5;
				break;
			case 4:
				IOWR_ALTERA_AVALON_PIO_DATA(ADDR_BASE, 0x00);
				IOWR_ALTERA_AVALON_PIO_DATA(SEND_BASE, 0xa0000000);
				state = 3;
				break;
			case 3:
				IOWR_ALTERA_AVALON_PIO_DATA(ADDR_BASE, 0x00);
				IOWR_ALTERA_AVALON_PIO_DATA(SEND_BASE, 0xa0010000);
				state = 2;
				break;
			case 2:
				IOWR_ALTERA_AVALON_PIO_DATA(ADDR_BASE, 0x01);
				IOWR_ALTERA_AVALON_PIO_DATA(SEND_BASE, 0xb1000000);
				state = 1;
				break;
			case 1:
				IOWR_ALTERA_AVALON_PIO_DATA(ADDR_BASE, 0x01);
				IOWR_ALTERA_AVALON_PIO_DATA(SEND_BASE, 0xb1010000);
				state = 0;
				break;
			}
		}
	}
}
